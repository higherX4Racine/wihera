---
title: "Wrangle Spring 2023 Data"
output:
  rmarkdown::html_vignette
---vignette: >
  %\VignetteIndexEntry{Wrangle Spring 2023 Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
.TEMPLATE_FILE <- system.file("extdata",
                              "2023_HERA_Data_Submission_form.xlsx",
                              package = "wihera")

.WI_STATE_FILE <- system.file("extdata",
                              "2023_Example_HERA_Data_Submission_form.xlsx",
                              package = "wihera")

```

Here are the data files that I will use.

```{r import_the_data}
template_sheets <- wihera::read_template(.TEMPLATE_FILE)

wi_state_sheets <- wihera::read_template(.WI_STATE_FILE)
```

## Things Tableau Didn't Catch:

- places where numerators were excluded (because < 10) but denominator

## Template Checking

There is a template sheet that each school was supposed to use to submit its data.
Like many spreadsheets, it encodes some of its information in cell locations.
If the schools changed the order of any of the column or row labels then there will be a mismatch between what they intended to report and what the automated import system will say that they reported.
The following code checks each submission against the template to catch mismatches.

```{r template_checking, results="asis"}
sheet_checks <- wihera::TEMPLATE_REGIONS_2023 |>
    purrr::imap( ~ wihera::check_school(wi_state_sheets[[.y]],
                                        .x,
                                        template_sheets[[.y]])
    )

purrr::iwalk(
    sheet_checks,
    function(.check, .sheet) {
        cat("\n\n#### ", .sheet, "\n\n", sep = "")
        purrr::walk(.check$messages,
                    purrr::iwalk,
                    wihera::mismatch_as_markdown,
                    "#####")
        cat("\n")
    }
)
```

```{r math_pathways_schema}
math_pathways_schema <- list(
    sheet = "Math Pathways",
    range = "A8:I11",
    col_names = c("Population",
                  "First-time cohort \n(Fall 2021)",
                  "Exempt",
                  "College Algebra",
                  "Quantitative Reasoning",
                  "Statistics",
                  "Technical Math",
                  "Other Course (total)",
                  "More than one gateway math course"
    ),
    col_types = c("text", rep("numeric", 8)),
    na = c("NA", "N/A", "DS")
)


math_pathways_offered_schema <- list(
    sheet = "Math Pathways",
    range = "C7:I7",
    col_names = c("Exempt",
                  "College Algebra",
                  "Quantitative Reasoning",
                  "Statistics",
                  "Technical Math",
                  "Other Course (total)",
                  "More than one gateway math course"
    ),
    col_types = "text",
    na = c("NA", "N/A", "DS")
)
```

